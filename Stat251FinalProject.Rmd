---
title: "Stat251 Final Project"
author: "Emily Liu"
date: "3/25/2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)

# libraries
library(tidyverse)
library(invgamma)

# set seed
set.seed(1234)
```

## Introduction

Alzheimer’s is a brain disease where cells degenerate and cause memory loss. 40 million people worldwide suffer from this disease and a cure does not exist. Although there is no definitive cause of Alzheimer’s, scientists speculate that genetics, aging, and environmental influences may affect the probability of developing the disease. Some specialists have found that the larger the brain, the more the brain may combat against the effects of cognitive atrophy. The total intracranial volume (TIV) is a way to quantify the size of the brain. TIV includes the volume of the cranium, brain, and spinal fluid. To discover how brain size relates to Alzheimer’s, we will investigate the average TIV for patients 60 years and older of those with and without the disease. The parameter of interest is the average TIV for demented and non-demented patients.

## Methods

```{r}
# filepath <- paste0('~/Documents/Winter 2022/Stat251/alzheimer.csv')
filepath <- 'alzheimer.csv'
alz <- read.csv(filepath, stringsAsFactors = TRUE)
```

```{r}
# measurements of total intracranial volume
demented <- alz %>% filter(Group == 'Demented')
nondemented <- alz %>% filter(Group == 'Nondemented')
```

Figure 1 is a plot of the TIV values for demented and non-demented groups. We see that these values have a uniform and bell-shaped distribution therefore, we use a normal distribution with parameters $\mu$ and $\sigma^2$ as the likelihood to model our data. The likelihood of our model is also listed below.

```{r, fig.cap='Histograms of TIV for Alzheimers patients.', fig.show='hold', out.width='50%'}

# histogram for demented patients
ggplot(demented, aes(x = eTIV)) +
  geom_histogram() +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 23)) +
  labs(title = 'Histogram of TIV for Demented Patients',
       x = 'TIV',
       y = 'Patient Count')

# histogram for nondemented patients
ggplot(nondemented, aes(x = eTIV)) +
  geom_histogram() +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 20)) +
  labs(title = 'Histogram of TIV for Non-demented Patients',
       x = 'TIV',
       y = 'Patient Count')
```

$x_i | \mu, \sigma^2 \sim N(\mu, \sigma^2),\,\,i = 1, ...n$

We assume that the prior parameter $\mu$ which represents that average TIV for both populations, is normally distributed. We also assume that the variance denoted by $\sigma^2$ follows an inverse gamma distribution because the variance of TIV for both populations is positive and right-skewed. The distributions of the prior distributions for our parameters are listed below. We assume the prior distributions for both the demented (D) and non-demented (N) populations to be the same.

\begin{center}
\textbf{Prior distribution for demented population}

$\mu_D \sim N(\lambda, \tau^2)$

$\sigma_D \sim IG(\gamma, \phi)$

\textbf{Prior distribution for non-demented population}

$\mu_N \sim N(\lambda, \tau^2)$

$\sigma_N \sim IG(\gamma, \phi)$
\end{center}


```{r}
# prior for mu
prior_mean <- 1500 # lambda
prior_var <- 500000 # tau^2

# prior for sigma2
prior_gamma <- 2
prior_phi <- 2
```


```{r, fig.cap='Prior distribution for the TIV measurement for a randomly selected patient.', fig.show='hold', out.width='50%'}

# plot prior distribution of mu
curve(dnorm(x, prior_mean, sqrt(prior_var)), 
      xlim = c(-1000, 4000),
      main = 'Prior Distribution of' ~mu,
      xlab = ~mu,
      ylab = 'Density')

# plot prior distribution of sigma2
curve(dinvgamma(x, prior_gamma, prior_phi), xlim = c(0, 10),
      main = 'Prior Distribution of' ~sigma^2,
      xlab = ~sigma^2,
      ylab = 'Density')
```

In order to investigate this question, we analyzed a dataset taken from Kaggle that includes data from a sampled set of patients 60 years and older. Metrics collected on these individuals include whether they have Alzheimer’s (our response variable), gender, age, education level, TIV measurements (our explanatory variable), and other physiological characteristics. The outcome variable of interest is whether the patient is demented or non-demented.

??put in kable
```{r}
# summaries of data
dem_stat <- as.integer(summary(demented$eTIV))
nondem_stat <- as.integer(summary(nondemented$eTIV))

row_names <- c('Min', 'Q1', 'Median', 'Mean', 'Q3', 'Max')

alz_stat <- as.data.frame(cbind(dem_stat, nondem_stat),
              row.names = row_names)
colnames(alz_stat) <- c('Demented', 'Non-Demented')

knitr::kable(
  alz_stat,
  col.names = c('Demented', 'Non-Demented'),
  digits = 3,
  caption = 'Patient TIV Summary Statistics'
)

# alz_stat %>% kableExtra::kbl(caption = 'Patient TIV Summary Statistics') %>%
#   kableExtra::kable_classic(full_width = FALSE, html_font = 'Cambria')
```

## Results

Because of our likelihood and prior distributions, we can approximate a posterior distribution for both populations $\mu$ and $\sigma^2$ with Gibbs sampling.

```{r, include=FALSE}
# set data
demented <- alz %>% filter(Group == 'Demented') %>% select(eTIV)
n <- nrow(demented)

# set prior parameters for mu
lambda <- prior_mean
tau2 <- prior_var 

# set prior parameters for sigma2
gamma <- prior_gamma
phi <- prior_phi

# set starting values for Gibbs sampling
mu <- 1500
sigma2 <- 1

# initializations for the Gibbs Sampling Algorithm
iters <- 10000
mu_save <- rep(0, iters)
sigma2_save <- rep(0, iters)

mu_save[1] <- mu
sigma2_save[1] <- sigma2

# Gibbs Sampling Algorithm
for(t in 2:iters){
  
  # full conditional of mu (update the value of the parameters)
  lambda_p <- (tau2*sum(demented) + sigma2*lambda) / (tau2*n + sigma2) 
  tau2_p <- sigma2*tau2 / (tau2*n + sigma2) # posterior variance
  
  # sample a new value of mu from its full conditional
  mu <- rnorm(1, lambda_p, sqrt(tau2_p))
  
  # save the value of mu
  mu_save[t] <- mu
  
  # full conditional of sigma2 (update the value of the parameters)
  gamma_p <- gamma + n/2
  phi_p <- phi + sum((demented - mu)^2)/2
  
  # sample new value of sigma2 from its full conditional
  sigma2 <- rinvgamma(1, gamma_p, phi_p)
  
  # save the value of sigma2
  sigma2_save[t] <- sigma2
}

# trace plots to determine burn-in
plot(mu_save, type='l')
plot(sigma2_save, type='l')

# throw out the first few values
burn <- 100
mu_use_demented <- mu_save[-(1:burn)]
sigma2_use_demented <- sigma2_save[-(1:burn)]
plot(mu_use_demented, type='l')
plot(sigma2_use_demented, type='l')
```

```{r fig.cap='Posterior distribution for average the TIV measurement of a patient with Alzheimers.', fig.show='hold', out.width='50%'}
## plotting posterior distribution for demented

# marginal posterior distribution of mu (NOT conditional on sigma2)
plot(density(mu_use_demented), xlim=c(1400, 1600), 
     xlab = ~mu, 
     ylab = "Density", 
     main = expression(pi(mu~"|"~data)))

# marginal posterior distribution of sigma2 (NOT conditional on mu)
# plot(density(sigma2_use_demented), 
#      # xlim = c(0, 1000),  
#      # ylim = c(0.000000002, 0.000000004),
#      xlab=expression(sigma^2), 
#      ylab="Density", main=expression(pi(sigma^2~"|"~data)))


# marginal posterior distribution of sigma (NOT conditional on mu)
plot(density(sqrt(sigma2_use_demented)), 
     xlab = ~sigma, 
     ylab = "Density", 
     main = expression(pi(sigma~"|"~data)))
```

The mean and variance of our posterior distribution for demented patients are `r round(mean(mu_use_demented), 4)` and `r round(mean(sigma2_use_demented), 4)` respectively.

```{r include=FALSE}
# set data
nondemented <- alz %>% filter(Group == 'Nondemented') %>% select(eTIV)
n <- nrow(nondemented)

# set prior parameters for mu
lambda <- prior_mean
tau2 <- prior_var

# set prior for sigma2
gamma <- prior_gamma
phi <- prior_phi

# set starting values for Gibbs sampling
mu <- 1500
sigma2 <- 1

# initializations for the Gibbs Sampling Algorithm
iters <- 10000
mu_save <- rep(0, iters)
sigma2_save <- rep(0, iters)

mu_save[1] <- mu
sigma2_save[1] <- sigma2

# Gibbs Sampling Algorithm
for(t in 2:iters){
  
  # full conditional of mu (update the value of the parameters)
  lambda_p <- (tau2*sum(nondemented) + sigma2*lambda)/(tau2*n + sigma2)
  tau2_p <- sigma2*tau2/(tau2*n + sigma2)
  
  # sample a new value of mu from its full conditional
  mu <- rnorm(1, lambda_p, sqrt(tau2_p))
  
  # save the value of mu
  mu_save[t] <- mu
  
  # full conditional of sigma2 (update the value of the parameters)
  gamma_p <- gamma + n/2
  phi_p <- phi + sum((nondemented - mu)^2 )/2
  
  # sample new value of sigma2 from its full conditional
  sigma2 <- rinvgamma(1, gamma_p, phi_p)
  
  # save the value of sigma2
  sigma2_save[t] <- sigma2
}

# trace plots to determine burn-in
plot(mu_save, type='l')
plot(sigma2_save, type='l')

# throw out the first few values
burn <- 100
mu_use_nondemented <- mu_save[-(1:burn)]
sigma2_use_nondemented <- sigma2_save[-(1:burn)]
plot(mu_use_nondemented, type='l')
plot(sigma2_use_nondemented, type='l')
```

```{r fig.cap='Posterior distribution for average the TIV measurement of a patient without Alzheimers.', fig.show='hold', out.width='50%'}
## posterior distribution of non-demented

# marginal posterior distribution of mu
plot(density(mu_use_nondemented), 
     xlab = ~mu, 
     ylab = "Density", 
     main = expression(pi(mu~"|"~data)))

# marginal posterior distribution of sqrt(sigma2) (standard deviation)
plot(density(sqrt(sigma2_use_nondemented)), 
     xlab = ~sigma, 
     ylab = "Density", 
     main = expression(pi(sigma~"|"~data)))
```

The mean and variance of our posterior distribution for demented patients are `r round(mean(mu_use_nondemented), 4)` and `r round(mean(sigma2_use_nondemented), 4)` respectively.

We conducted this analysis because we wanted to understand if there was a difference between average TIV measurements of patients with and without Alzheimer’s. In the plot below (posterior distribution of the difference in means), we see that the average TIV difference (Demented - Nondemented) is -9.466. This means that on average, the non-demented patients have 9.466 cm^3 more total intracranial volume than demented patients. This confirms our hunch that Alzheimer’s erodes away brain matter. The 95% credible interval of this distribution is between -47.7 and 28.8. Because this credible interval contains zero, we conclude that these results are not significant.

```{r fig.cap='Posterior distribution for the difference in average TIV measurements between patients with and without Alzheimers.', fig.align='center', fig.show='hold', out.width='50%'}

# take difference between distribution
d <- mu_use_demented - mu_use_nondemented

# plot posterior distribution in difference of means
plot(density(d), 
     xlim = c(-100, 100), 
     xlab= expression(~mu_D~'-'~mu_N), 
     ylab = "Density",
     main = 'Posterior Distribution of Difference in Means')

# measure the mean of the distribution
postdiff_mu <- mean(d)

# 95% credible interval
quant <- quantile(d, c(.025, .975)) 
# The difference between TIV size between demented and nondemented is insignificant since our credible interval contains 0.
```

```{r include=FALSE, fig.cap='Posterior predictive distribution for the difference in average TIV measurements between patients with and without Alzheimers.', fig.show='hold', out.width='50%'}
## posterior predictive

# posterior predictive for both populations
dem_postpred <- rnorm(100000, mu_use_demented, sqrt(sigma2_use_demented))
nondem_postpred <- rnorm(100000, mu_use_nondemented, sqrt(sigma2_use_nondemented))

# plot the posterior predictive for both populations
plot(density(dem_postpred),
     xlim = c(500, 2500),
     main = 'Posterior Predictive Distribution for Patients With Alzheimer\'s',
     xlab = 'TIV')
plot(density(nondem_postpred), xlim = c(500, 2500),
     main = 'Posterior Predictive Distribution for Patients Without Alzheimer\'s',
     xlab = 'TIV')
```
